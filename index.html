<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Комічне у мемах воєнного часу — 2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body {font-family:'Comic Sans MS',Arial;background:linear-gradient(135deg,#0057b7,#ffd700);color:white;margin:0;padding:20px;min-height:100vh;}
  h1,h2 {text-align:center;margin:20px 0;}
  .tabs {display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin:30px 0;}
  .tab {padding:15px 30px;background:#000;color:#ffd700;border:3px solid #ffd700;border-radius:15px;cursor:pointer;font-weight:bold;font-size:1.3em;}
  .tab.active {background:#ffd700;color:#000;}
  .content {display:none;background:rgba(0,0,0,0.85);padding:40px;border-radius:25px;max-width:1100px;margin:20px auto;}
  .content.active {display:block;}
  .section {background:rgba(0,50,100,0.9);padding:40px 25px 25px;margin:20px 0;border:4px dashed #ffd700;border-radius:15px;min-height:240px;position:relative;}
  .section-title {position:absolute;top:-18px;left:20px;background:#0057b7;padding:10px 25px;border-radius:20px;font-size:1.4em;font-weight:bold;box-shadow:0 0 20px #ff0;z-index:10;}
  .section-content {min-height:200px;}
  .meme {width:190px;margin:10px;border:5px solid #fff;border-radius:15px;cursor:grab;box-shadow:0 0 20px #ff0;transition:0.3s;position:relative;display:inline-block;}
  .meme:active {transform:scale(1.15);}
  .meme-bank {display:flex;flex-wrap:wrap;justify-content:center;gap:15px;padding:20px;background:rgba(0,0,0,0,0.5);border-radius:20px;}
  button {background:#ffd700;color:#000;padding:14px 28px;margin:12px;font-size:1.2em;border:none;border-radius:12px;cursor:pointer;font-weight:bold;}
  button:hover {background:#fff;}
  .admin {background:#c00;padding:15px;text-align:center;font-weight:bold;}
  #adminLogin {text-align:center;margin:30px;}
  .add-meme-block {background:rgba(0,0,0,0.6);padding:20px;border-radius:15px;margin:20px 0;text-align:center;}
  .delete-btn {position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;font-size:18px;cursor:pointer;display:none;}
  .meme:hover .delete-btn {display:block;}
  .search-result {text-align:center;margin:40px;padding:30px;background:#000;border:5px solid #ffd700;border-radius:20px;}
  .search-result img {max-width:90%;border-radius:20px;margin:20px 0;}
</style>
</head>
<body>

<h1>КОМІЧНЕ У МЕМАХ ВОЄННОГО ЧАСУ</h1>

<div id="adminLogin">
  <input type="password" id="pass" placeholder="Пароль адміна (Lyceum53)">
  <button onclick="login()">Увійти</button>
</div>
<div id="adminPanel" class="admin" style="display:none;">АДМІН-РЕЖИМ <button onclick="logout()">Вийти</button></div>

<div class="tabs">
  <div class="tab active" data-tab="constructor">Конструктор</div>
  <div class="tab" data-tab="quest">Квест</div>
  <div class="tab" data-tab="search">Пошук</div>
  <div class="tab" data-tab="gallery">Каталог</div>
</div>

<!-- КОНСТРУКТОР -->
<div id="constructor" class="content active">
  <h2 style="text-align:center;">Перетягни меми в розділи</h2>

  <div class="add-meme-block" id="addMemeBlock" style="display:none;">
    <h3>Додати новий мем</h3>
    <input type="file" id="newMemeFile" accept="image/*"><br><br>
    <input type="text" id="newMemeUrl" placeholder="або встав посилання"><br><br>
    <select id="newIntent">
      <option value="">Обери інтенцію</option>
      <option>Підтримка морального духу</option>
      <option>Висміювання ворога</option>
      <option>Ідеалізація особистості</option>
      <option>Дискредитація ворога</option>
      <option>Підтримка морального духу українського народу</option>
    </select>
    <select id="newDevice">
      <option value="">Обери засіб</option>
      <option>гумор</option>
      <option>іронія</option>
      <option>сатира</option>
      <option>сарказм</option>
    </select>
    <button onclick="addNewMeme()">Додати мем</button>
  </div>

  <div id="memeBank" class="meme-bank"></div>

  <h2 style="text-align:center;margin-top:50px;">Інтенції</h2>

  <div class="section" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="section-title">Підтримка морального духу</div>
    <div class="section-content" id="s1"></div>
  </div>
  <div class="section" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="section-title">Висміювання ворога</div>
    <div class="section-content" id="s2"></div>
  </div>
  <div class="section" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="section-title">Ідеалізація особистості</div>
    <div class="section-content" id="s3"></div>
  </div>
  <div class="section" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="section-title">Дискредитація ворога</div>
    <div class="section-content" id="s4"></div>
  </div>
  <div class="section" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="section-title">Підтримка морального духу українського народу</div>
    <div class="section-content" id="s5"></div>
  </div>
</div>

<!-- ПОШУК -->
<div id="search" class="content">
  <h2>Пошук за інтенцією та засобом</h2>
  <div style="text-align:center;">
    <select id="intentSelect" style="padding:15px;font-size:1.3em;margin:15px;">
      <option value="">Обери інтенцію</option>
      <option>Підтримка морального духу</option>
      <option>Висміювання ворога</option>
      <option>Ідеалізація особистості</option>
      <option>Дискредитація ворога</option>
      <option>Підтримка морального духу українського народу</option>
    </select>
    <br>
    <select id="deviceSelect" style="padding:15px;font-size:1.3em;margin:15px;">
      <option value="">Обери засіб</option>
      <option>гумор</option>
      <option>іронія</option>
      <option>сатира</option>
      <option>сарказм</option>
    </select>
    <br><br>
    <button onclick="searchMeme()" style="font-size:1.5em;padding:20px 50px;">Знайти мем</button>
  </div>
  <div id="searchResult" class="search-result"></div>
</div>

<!-- ГАЛЕРЕЯ -->
<div id="gallery" class="content">
  <h2>Готовий каталог</h2>
  <div id="savedCatalog"></div>
</div>

<script>
// Твій Supabase
const supabase = window.supabase.createClient(
  'https://goklujojesauzxwpdqdp.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdva2x1am9qZXNhdXp4d3BkcWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTgxNjgsImV4cCI6MjA4MDQzNDE2OH0.iRo0Sz54Us3eeUweqxq4NuYAIjPSIdTWgfCgZhec8Fc'
);

const ADMIN_PASS = 'Lyceum53';
let isAdmin = false;

// === ВКЛАДКИ — працює ===
function openTab(tabId) {
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId)?.classList.add('active');
  document.querySelector(`.tab[data-tab="${tabId}"]`)?.classList.add('active');
  if (tabId === 'gallery') showGallery();
}
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => openTab(tab.dataset.tab));
});

// === АДМІН ===
function login() {
  if (document.getElementById('pass').value === ADMIN_PASS) {
    isAdmin = true;
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('addMemeBlock').style.display = 'block';
    loadMemes();
  } else alert('Неправильний пароль');
}
function logout() { location.reload(); }

// === ЗАВАНТАЖЕННЯ МЕМІВ ===
async function loadMemes() {
  let data;
  try {
    const res = await supabase.from('memes').select('*');
    data = res.data;
  } catch (e) {
    console.log('Supabase не підключився — використовуємо статичні меми');
  }

  const bank = document.getElementById('memeBank');
  bank.innerHTML = '';

  const memes = data && data.length > 0 ? data : [
    {src: "https://i.ibb.co/4pQ8hZc/palianytsya1.jpg"},
    {src: "https://i.ibb.co/09T1s1Q/ship.jpg"},
    {src: "https://i.ibb.co/4pQ8hZc/patron1.jpg"},
    {src: "https://i.ibb.co/4pQ8hZc/tractor1.jpg"}
  ];

  memes.forEach((m, idx) => {
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.display = 'inline-block';

    const img = document.createElement('img');
    img.className = 'meme';
    img.src = m.src;
    img.draggable = true;
    img.ondragstart = drag;

    if (isAdmin && data) { // кнопка видалення тільки якщо меми з бази
      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = '×';
      del.onclick = (e) => {
        e.stopPropagation();
        if (confirm('Видалити мем?')) {
          supabase.from('memes').delete().eq('id', m.id).then(() => loadMemes());
        }
      };
      wrapper.appendChild(del);
    }

    wrapper.appendChild(img);
    bank.appendChild(wrapper);
  });

  loadCatalog();
}

// === ДОДАТИ МЕМ ===
async function addNewMeme() {
  if (!isAdmin) return alert('Тільки адмін!');
  const intent = document.getElementById('newIntent').value;
  const device = document.getElementById('newDevice').value;
  if (!intent || !device) return alert('Обери інтенцію і засіб!');

  let src = document.getElementById('newMemeUrl').value.trim();
  const file = document.getElementById('newMemeFile').files[0];

  if (file) {
    const { data, error } = await supabase.storage.from('memes').upload('public/'+Date.now()+'_'+file.name, file);
    if (error) { alert('Помилка завантаження: ' + error.message); return; }
    src = supabase.storage.from('memes').getPublicUrl(data.path).data.publicUrl;
  }

  if (!src) return alert('Встав посилання або вибери файл!');

  const { error } = await supabase.from('memes').insert({ src, intent, device });
  if (error) alert('Помилка: ' + error.message);
  else {
    alert('Мем додано!');
    loadMemes();
  }
}

// === ЗБЕРЕЖЕННЯ ТА ВІДНОВЛЕННЯ КАТАЛОГУ ===
async function saveCatalog() {
  if (!isAdmin) return;
  const catalog = {
    s1: document.querySelector('#s1 .section-content')?.innerHTML || '',
    s2: document.querySelector('#s2 .section-content')?.innerHTML || '',
    s3: document.querySelector('#s3 .section-content')?.innerHTML || '',
    s4: document.querySelector('#s4 .section-content')?.innerHTML || '',
    s5: document.querySelector('#s5 .section-content')?.innerHTML || ''
  };
  await supabase.from('catalog').upsert({ id: 1, ...catalog });
}

async function loadCatalog() {
  const { data } = await supabase.from('catalog').select('*').eq('id', 1).single();
  .catch(() => ({data: null}));
  if (data) {
    for (let i = 1; i <= 5; i++) {
      const el = document.querySelector(`#s${i} .section-content`);
      if (el) el.innerHTML = data[`s${i}`] || '';
    }
  }
  showGallery();
}

function showGallery() {
  const titles = ["Підтримка морального духу","Висміювання ворога","Ідеалізація особистості","Дискредитація ворога","Підтримка морального духу українського народу"];
  let html = '';
  for (let i = 1; i <= 5; i++) {
    const content = document.querySelector(`#s${i} .section-content`)?.innerHTML.trim();
    if (content) html += `<h2>${titles[i-1]}</h2><div class="section"><div class="section-content">${content}</div></div>`;
  }
  document.getElementById('savedCatalog').innerHTML = html || '<p style="text-align:center;color:#ff0;">Каталог порожній — розсортуй меми!</p>';
}

// === DRAG & DROP ===
function allowDrop(e) { e.preventDefault(); }
function drag(e) { e.dataTransfer.setData("text", e.target.outerHTML); }
function drop(e) {
  e.preventDefault();
  const section = e.target.closest('.section');
  if (section) {
    const content = section.querySelector('.section-content');
    if (content) {
      content.innerHTML += e.dataTransfer.getData("text");
      if (isAdmin) saveCatalog();
    }
  }
}

// === ПОШУК ===
async function searchMeme() {
  const intent = document.getElementById('intentSelect').value;
  const device = document.getElementById('deviceSelect').value;
  if (!intent || !device) return alert('Обери обидва параметри!');

  const { data } = await supabase.from('memes').select('*').eq('intent', intent).eq('device', device);
  const div = document.getElementById('searchResult');
  if (!data || data.length === 0) {
    div.innerHTML = '<p style="color:#ff0;font-size:1.5em;">Немає мемів з такими параметрами</p>';
    return;
  }
  const meme = data[Math.floor(Math.random() * data.length)];
  div.innerHTML = `
    <img src="${meme.src}">
    <p style="font-size:1.5em;"><strong>Інтенція:</strong> ${meme.intent}<br>
    <strong>Засіб:</strong> ${meme.device}</p>
  `;
}

// === СТАРТ ===
loadMemes();
</script>
</body>
</html>
